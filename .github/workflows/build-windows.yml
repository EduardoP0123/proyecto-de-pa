name: Build Windows exe (PyInstaller)

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "App exe name (e.g., KV2C & KV2A ANALYZER v 2.0)"
        required: false
        default: "KV2C_KV2A_ANALYZER_v2.0"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compute names
        shell: powershell
        run: |
          $APP_NAME = "${{ github.event.inputs.app_name }}"
          if ([string]::IsNullOrWhiteSpace($APP_NAME)) { $APP_NAME = "KV2C_KV2A_ANALYZER_v2.0" }
          $SAFE_NAME = ($APP_NAME -replace '[^A-Za-z0-9._-]', '_')
          echo "APP_NAME=$APP_NAME" >> $env:GITHUB_ENV
          echo "SAFE_NAME=$SAFE_NAME" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build exe with PyInstaller
        shell: powershell
        run: |
          $addData = @()
          if (Test-Path "ui\images") { $addData += "--add-data \"ui\\images;ui\\images\"" }
          if (Test-Path "config") { $addData += "--add-data \"config;config\"" }
          $args = @(
            "-m", "PyInstaller",
            "--noconfirm", "--clean",
            "--windowed", "--onefile",
            "--name", "$env:SAFE_NAME",
            "--hidden-import", "tkcalendar",
            "--hidden-import", "openpyxl"
          ) + $addData + @("run_app.py")
          & python $args

      - name: Zip exe
        shell: powershell
        run: |
          Compress-Archive -Path "dist\$env:SAFE_NAME.exe" -DestinationPath "dist\$env:SAFE_NAME-windows.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SAFE_NAME }}-windows
          path: dist/${{ env.SAFE_NAME }}-windows.zip
