name: Release (Windows + macOS)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Git tag for the release (e.g., v2.0.0)"
        required: true
      app_name:
        description: "Display app name (e.g., KV2C & KV2A ANALYZER v 2.0)"
        required: false
        default: "KV2C & KV2A ANALYZER v 2.0"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compute names
        shell: powershell
        run: |
          $APP_NAME = "${{ github.event.inputs.app_name }}"
          if ([string]::IsNullOrWhiteSpace($APP_NAME)) { $APP_NAME = "KV2C & KV2A ANALYZER v 2.0" }
          $SAFE_NAME = ($APP_NAME -replace '[^A-Za-z0-9._-]', '_')
          echo "APP_NAME=$APP_NAME" >> $env:GITHUB_ENV
          echo "SAFE_NAME=$SAFE_NAME" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build exe with PyInstaller
        shell: powershell
        run: |
          $addData = @()
          if (Test-Path "ui\images") { $addData += "--add-data \"ui\\images;ui\\images\"" }
          if (Test-Path "config") { $addData += "--add-data \"config;config\"" }
          $args = @(
            "-m", "PyInstaller",
            "--noconfirm", "--clean",
            "--windowed", "--onefile",
            "--name", "$env:SAFE_NAME",
            "--hidden-import", "tkcalendar",
            "--hidden-import", "openpyxl"
          ) + $addData + @("run_app.py")
          & python $args

      - name: Zip exe
        shell: powershell
        run: |
          Compress-Archive -Path "dist\$env:SAFE_NAME.exe" -DestinationPath "dist\$env:SAFE_NAME-windows.zip" -Force

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SAFE_NAME }}-windows
          path: dist/${{ env.SAFE_NAME }}-windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compute names
        shell: bash
        run: |
          APP_NAME='${{ github.event.inputs.app_name }}'
          if [ -z "$APP_NAME" ]; then APP_NAME='KV2C & KV2A ANALYZER v 2.0'; fi
          SAFE_NAME=$(echo "$APP_NAME" | sed -E 's/[^A-Za-z0-9._-]/_/g')
          echo "APP_NAME=$APP_NAME" >> "$GITHUB_ENV"
          echo "SAFE_NAME=$SAFE_NAME" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build app with PyInstaller (.app bundle)
        shell: bash
        run: |
          ADD_DATA_ARGS=""
          if [ -d "ui/images" ]; then ADD_DATA_ARGS="$ADD_DATA_ARGS --add-data ui/images:ui/images"; fi
          if [ -d "config" ]; then ADD_DATA_ARGS="$ADD_DATA_ARGS --add-data config:config"; fi
          pyinstaller \
            --noconfirm --clean \
            --windowed \
            --name "$SAFE_NAME" \
            --hidden-import tkcalendar \
            --hidden-import openpyxl \
            $ADD_DATA_ARGS \
            run_app.py

      - name: Zip .app
        shell: bash
        run: |
          cd dist
          zip -r "$SAFE_NAME-mac.zip" "$SAFE_NAME.app"

      - name: Upload artifact (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SAFE_NAME }}-mac
          path: dist/${{ env.SAFE_NAME }}-mac.zip

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    steps:
      - name: Compute names
        shell: bash
        run: |
          APP_NAME='${{ github.event.inputs.app_name }}'
          if [ -z "$APP_NAME" ]; then APP_NAME='KV2C & KV2A ANALYZER v 2.0'; fi
          SAFE_NAME=$(echo "$APP_NAME" | sed -E 's/[^A-Za-z0-9._-]/_/g')
          echo "APP_NAME=$APP_NAME" >> "$GITHUB_ENV"
          echo "SAFE_NAME=$SAFE_NAME" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version_tag }}
          release_name: ${{ github.event.inputs.version_tag }} - ${{ github.event.inputs.app_name }}
          draft: false
          prerelease: false

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SAFE_NAME }}-windows
          path: release/windows

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SAFE_NAME }}-mac
          path: release/macos

      - name: Upload asset (Windows zip)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/windows/${{ env.SAFE_NAME }}-windows.zip
          asset_name: ${{ env.SAFE_NAME }}-windows.zip
          asset_content_type: application/zip

      - name: Upload asset (macOS zip)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/macos/${{ env.SAFE_NAME }}-mac.zip
          asset_name: ${{ env.SAFE_NAME }}-mac.zip
          asset_content_type: application/zip
